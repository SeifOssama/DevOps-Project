---
plugin: amazon.aws.aws_ec2
regions:
  - us-east-1

# Only include running instances
filters:
  instance-state-name: running

# Use DNS name or private IP as hostname (NOT the literal string)
# This ensures each instance gets a unique hostname
hostnames:
  - dns-name
  - private-ip-address

# Use keyed_groups to create groups based on tags
keyed_groups:
  # This creates a group for each unique Name tag value
  # e.g., tag_Name_webserver0, tag_Name_webserver1, tag_Name_monitoring_node
  - key: tags.Name
    prefix: tag_Name
    separator: "_"

# Create custom groups based on instance tags
groups:
  webservers: "tags.Name is defined and ('webserver0' in tags.Name or 'webserver1' in tags.Name or tags.Name.startswith('webserver'))"
  monitoring: "tags.Name is defined and tags.Name == 'monitoring-node'"

# Compose variables for Ansible
compose:
  # Set ansible_host to use the public IP for SSH from GitHub Actions
  ansible_host: public_ip_address
  ansible_user: "'ubuntu'"
