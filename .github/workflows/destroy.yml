name: Destroy All Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "destroy" to confirm infrastructure destruction'
        required: true
        default: ''

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  destroy:
    runs-on: ubuntu-latest
    name: Destroy All Infrastructure
    # Only run if confirmation matches
    if: github.event.inputs.confirmation == 'destroy'
    
    steps:
      - name: âš ï¸  Destroy Warning
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘             âš ï¸  INFRASTRUCTURE DESTRUCTION  âš ï¸            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "This workflow will destroy ALL infrastructure created by Terraform:"
          echo "  â€¢ Monitoring Node EC2"
          echo "  â€¢ Webserver EC2 instances"
          echo "  â€¢ VPC, Subnets, Security Groups"
          echo "  â€¢ SSH Key Pairs"
          echo ""
          echo "âš ï¸  Note: S3 state bucket and DynamoDB table will be preserved"
          echo ""
          echo "â³ Starting in 10 seconds..."
          sleep 10
      
      - name: ğŸ“‹ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: âœ… Verify AWS Credentials
        run: |
          echo "Verifying AWS credentials..."
          CALLER_IDENTITY=$(aws sts get-caller-identity)
          ACCOUNT_ID=$(echo $CALLER_IDENTITY | jq -r '.Account')
          echo "âœ… AWS Account: $ACCOUNT_ID"
      
      - name: ğŸ“Š Pre-Destroy EC2 Inventory
        id: pre_destroy_inventory
        run: |
          echo "Recording current EC2 instances before destroy..."
          echo ""
          
          # Get all instances with our project tags
          INSTANCES=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
                      "Name=instance-state-name,Values=running,stopped,stopping,pending" \
            --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],State.Name]' \
            --output text)
          
          if [ -n "$INSTANCES" ]; then
            echo "Found instances to destroy:"
            echo "$INSTANCES"
            INSTANCE_COUNT=$(echo "$INSTANCES" | wc -l)
            echo "instance_count=$INSTANCE_COUNT" >> $GITHUB_OUTPUT
            echo ""
            echo "Total instances: $INSTANCE_COUNT"
          else
            echo "No instances found to destroy"
            echo "instance_count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
      
      - name: ğŸ”“ Clear Stuck Locks (if any)
        continue-on-error: true
        run: |
          echo "Checking for stuck locks..."
          
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="devops-project-terraform-state-$ACCOUNT_ID"
          
          # Attempt to clear any stuck locks
          aws dynamodb delete-item \
            --table-name terraform-state-locks \
            --key "{\"LockID\": {\"S\": \"$BUCKET_NAME/devops-project/terraform.tfstate\"}}" \
            2>/dev/null || echo "No stuck locks found (or table doesn't exist)"
          
          echo "âœ… Lock check complete"
      
      - name: ğŸ—ï¸ Terraform Init
        run: |
          echo "::group::Terraform Initialization"
          cd Terraform
          
          echo "Initializing Terraform with remote backend..."
          echo "Backend: s3://${{ secrets.TF_BACKEND_BUCKET }}"
          
          # Try to initialize with remote backend
          if terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_BACKEND_DYNAMODB_TABLE }}" \
            -backend-config="region=${{ secrets.TF_BACKEND_REGION }}"; then
            echo "âœ… Terraform initialized with remote backend"
          else
            echo "âš ï¸  Remote backend initialization failed"
            echo "   This may indicate the backend was already destroyed"
            echo "   or never existed. Cannot proceed with destroy."
            echo ""
            echo "If you need to clean up local resources, use AWS Console."
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: ğŸ”„ Refresh State (Detect Drift)
        continue-on-error: true
        run: |
          echo "::group::State Refresh"
          cd Terraform
          
          echo "Refreshing Terraform state to detect manually deleted resources..."
          terraform apply -refresh-only -auto-approve \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" || {
            echo "âš ï¸  State refresh failed or had errors"
            echo "   This is normal if resources were manually deleted"
          }
          
          echo "::endgroup::"
      
      - name: ğŸ“‹ List Resources to be Destroyed
        continue-on-error: true
        run: |
          echo "::group::Resources to be Destroyed"
          cd Terraform
          
          echo "ğŸ“‹ Current infrastructure state:"
          echo ""
          
          # Show all instances
          terraform show -json 2>/dev/null | \
            jq -r '.values.root_module.resources[]? | select(.type == "aws_instance") | "\(.type).\(.name): \(.values.tags.Name // "N/A")"' || \
            echo "Unable to list resources (state may be empty or corrupted)"
          
          echo ""
          echo "Full resource count:"
          terraform state list 2>/dev/null | wc -l || echo "0"
          
          echo "::endgroup::"
      
      - name: ğŸ§¹ Terraform Destroy (Attempt 1)
        id: destroy_attempt_1
        continue-on-error: true
        run: |
          echo "::group::Terraform Destroy - Attempt 1"
          cd Terraform
          
          echo "ğŸ—‘ï¸  Destroying all infrastructure..."
          echo ""
          
          terraform destroy \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -auto-approve \
            -refresh=true
          
          DESTROY_EXIT_CODE=$?
          
          if [ $DESTROY_EXIT_CODE -eq 0 ]; then
            echo "âœ… Terraform destroy succeeded"
            echo "destroy_success=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Terraform destroy had errors (exit code: $DESTROY_EXIT_CODE)"
            echo "destroy_success=false" >> $GITHUB_OUTPUT
          fi
          
          echo "::endgroup::"
      
      - name: ğŸ”„ Retry Destroy (Attempt 2)
        if: steps.destroy_attempt_1.outputs.destroy_success != 'true'
        continue-on-error: true
        run: |
          echo "::group::Terraform Destroy - Attempt 2 (Retry)"
          cd Terraform
          
          echo "Retrying destroy with parallelism=1 (safer, slower)..."
          echo ""
          
          terraform destroy \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -auto-approve \
            -refresh=true \
            -parallelism=1
          
          echo "::endgroup::"
      
      - name: ğŸ”’ Check Termination Protection
        continue-on-error: true
        run: |
          echo "Checking for instances with termination protection..."
          
          PROTECTED_INSTANCES=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
                      "Name=instance-state-name,Values=running,stopped,stopping,pending" \
            --query 'Reservations[*].Instances[*].InstanceId' \
            --output text)
          
          if [ -n "$PROTECTED_INSTANCES" ]; then
            echo "Found instances, checking termination protection..."
            for instance in $PROTECTED_INSTANCES; do
              PROTECTION=$(aws ec2 describe-instance-attribute \
                --instance-id $instance \
                --attribute disableApiTermination \
                --query 'DisableApiTermination.Value' \
                --output text 2>/dev/null || echo "false")
              
              if [ "$PROTECTION" = "True" ] || [ "$PROTECTION" = "true" ]; then
                echo "âš ï¸  WARNING: Instance $instance has termination protection enabled"
                echo "   You must disable it manually before it can be destroyed"
              fi
            done
          else
            echo "No instances found to check"
          fi
      
      - name: ğŸ” Verify All EC2 Instances Terminated
        id: verify_destruction
        run: |
          echo "::group::EC2 Termination Verification"
          
          echo "â³ Waiting 30 seconds for AWS eventual consistency..."
          sleep 30
          
          echo ""
          echo "Checking for remaining EC2 instances..."
          
          # Check multiple tag patterns to catch all instances
          ALL_INSTANCES=""
          
          # Check: Instances with ManagedBy tag (not terminated or terminating)
          MANAGED_INSTANCES=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
                      "Name=instance-state-name,Values=running,stopped,stopping,pending,shutting-down" \
            --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],State.Name,LaunchTime]' \
            --output text)
          
          ALL_INSTANCES="$MANAGED_INSTANCES"
          
          if [ -n "$ALL_INSTANCES" ]; then
            echo "::error::âŒ VERIFICATION FAILED: Found remaining instances after destroy"
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘           âŒ EC2 INSTANCES STILL EXIST                    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The following instances are still present in AWS:"
            echo ""
            echo "InstanceId          Name                    State           LaunchTime"
            echo "--------------------------------------------------------------------------------"
            echo "$ALL_INSTANCES"
            echo ""
            INSTANCE_COUNT=$(echo "$ALL_INSTANCES" | wc -l)
            echo "Total remaining: $INSTANCE_COUNT instance(s)"
            echo ""
            echo "ğŸ”§ Possible causes:"
            echo "   1. Terraform destroy failed to remove all resources"
            echo "   2. Instances were created outside of Terraform"
            echo "   3. AWS API delays (eventual consistency)"
            echo "   4. Instance termination protection is enabled"
            echo ""
            echo "ğŸ“ Next steps:"
            echo "   1. Check the Terraform destroy logs above"
            echo "   2. Manually terminate instances from AWS Console if needed"
            echo "   3. Check for termination protection:"
            echo "      aws ec2 describe-instance-attribute --instance-id <ID> --attribute disableApiTermination"
            echo "   4. Re-run this workflow after manual cleanup"
            echo ""
            echo "verification_passed=false" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 1
          else
            echo "âœ… SUCCESS: No EC2 instances found"
            echo ""
            echo "Verified that all instances have been terminated."
            echo "verification_passed=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
          fi
      
      - name: ğŸ“Š Verify Destruction Complete
        run: |
          echo "::group::Destruction Verification"
          cd Terraform
          
          # Check if state file is empty
          RESOURCE_COUNT=$(terraform state list 2>/dev/null | wc -l || echo "0")
          
          echo "Remaining resources in state: $RESOURCE_COUNT"
          
          if [ "$RESOURCE_COUNT" -eq "0" ]; then
            echo "âœ… All resources successfully destroyed"
          else
            echo "âš ï¸  Some resources may still exist:"
            terraform state list || echo "Unable to list state"
            echo ""
            echo "You may need to manually clean up these resources"
          fi
          
          echo "::endgroup::"
      
      - name: ğŸ”„ Restore Provider Configuration
        if: always()
        continue-on-error: true
        run: |
          cd Terraform
          
          # Restore original provider.tf if it was backed up
          if [ -f provider.tf.backup ]; then
            echo "Restoring original provider.tf..."
            mv provider.tf.backup provider.tf
            echo "âœ… Restored"
          fi
      
      - name: âœ… Destruction Summary
        if: always()
        run: |
          cd Terraform
          
          RESOURCE_COUNT=$(terraform state list 2>/dev/null | wc -l || echo "0")
          VERIFICATION_PASSED="${{ steps.verify_destruction.outputs.verification_passed }}"
          
          if [ "$RESOURCE_COUNT" -eq "0" ] && [ "$VERIFICATION_PASSED" = "true" ]; then
            cat <<EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          âœ… Infrastructure Destroyed Successfully         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          All AWS resources have been removed and verified.
          
          âœ… Terraform State: Empty (0 resources)
          âœ… EC2 Verification: Passed (no instances found)
          
          ğŸ“ Preserved Resources (by design):
             â€¢ S3 State Bucket: devops-project-terraform-state-*
             â€¢ DynamoDB Lock Table: terraform-state-locks
          
          These backend resources contain state history and are preserved.
          You can safely deploy again at any time.
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          else
            cat <<EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘               âŒ Destruction Incomplete                   â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Status:
          â€¢ Terraform State: $RESOURCE_COUNT resources remaining
          â€¢ EC2 Verification: $VERIFICATION_PASSED
          
          âš ï¸  Action Required:
          1. Check the verification logs above for details
          2. Review AWS Console for orphaned resources
          3. Manually delete any stuck resources
          4. Re-run this workflow after cleanup
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
            exit 1
          fi
