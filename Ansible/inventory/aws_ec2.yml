---
plugin: amazon.aws.aws_ec2
regions:
  - us-east-1

# Only include running instances
filters:
  instance-state-name: running

# Use Name tag as hostname for better readability in output
# Falls back to DNS name if Name tag is not set
hostnames:
  - tag:Name
  - dns-name

# Use keyed_groups to create groups based on tags
keyed_groups:
  # This creates a group for each unique Name tag value
  # e.g., tag_Name_webserver0, tag_Name_webserver1, tag_Name_monitoring_node
  - key: tags.Name
    prefix: tag_Name
    separator: "_"

# Create custom groups based on instance tags
groups:
  webservers: "tags.Name is defined and ('webserver0' in tags.Name or 'webserver1' in tags.Name or tags.Name.startswith('webserver'))"
  monitoring: "tags.Name is defined and tags.Name == 'monitoring-node'"

# Compose variables for Ansible
compose:
  # Set ansible_host to use the public IP for SSH from GitHub Actions
  ansible_host: public_ip_address
  ansible_user: "'ubuntu'"
  # Explicitly set Python interpreter to suppress discovery warnings
  ansible_python_interpreter: "'/usr/bin/python3'"
  # Ensure inventory_hostname is set to Name tag for display purposes
  inventory_hostname: tags.Name | default(public_ip_address)
