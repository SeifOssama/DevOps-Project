---
- name: Deploy Prometheus exporters with Docker Compose
  hosts: all
  become: yes
  vars:
    docker_compose_dir: /opt/monitoring
    docker_compose_file: ../../Webservers/node-exporter-cadvisor-installation.yml 
    remote_compose_path: /opt/monitoring/docker-compose.yml

  tasks:

    # --------------------------------------------------
    # Docker is already installed via install-docker.yml
    # Starting directly with monitoring stack deployment
    # --------------------------------------------------
    
    # --------------------------------------------------
    # 1. Ensure user has docker group permissions active
    # --------------------------------------------------
    - name: Refresh SSH connection to ensure docker group is active
      meta: reset_connection

    # --------------------------------------------------
    # 2. Deploy monitoring stack
    # --------------------------------------------------
    - name: Ensure monitoring directory exists
      file:
        path: "{{ docker_compose_dir }}"
        state: directory
        mode: '0755'

    - name: Copy docker-compose.yml to target server
      copy:
        src: "{{ docker_compose_file }}"
        dest: "{{ remote_compose_path }}"
        mode: '0644'

    - name: Start Docker Compose services
      command: docker compose up -d
      args:
        chdir: "{{ docker_compose_dir }}"
      become: yes   # still recommended