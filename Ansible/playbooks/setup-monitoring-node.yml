---
- name: Setup Monitoring Node (Docker + Prometheus Stack)
  hosts: tag_Name_monitoring_node
  become: true
  gather_facts: true
  
  tasks:
    # ============================================
    # Reset connection to ensure docker group membership is active
    # ============================================
    - name: Reset connection to apply docker group permissions
      meta: reset_connection
      tags: [monitoring, setup]
    
    # ============================================
    # Docker is already installed via install-docker.yml
    # Starting directly with monitoring directory structure
    # ============================================
    
    # ============================================
    # Phase 1: Create Monitoring Directory Structure
    # ============================================
    - name: Create monitoring directory
      file:
        path: /home/ubuntu/monitoring
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      tags: [monitoring, setup]
    
    - name: Create prometheus directory
      file:
        path: /home/ubuntu/monitoring/prometheus
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      tags: [monitoring, setup]
    
    - name: Create alertmanager directory
      file:
        path: /home/ubuntu/monitoring/alertmanager
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      tags: [monitoring, setup]
    
    - name: Create grafana directories
      file:
        path: "/home/ubuntu/monitoring/grafana/{{ item }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      loop:
        - provisioning
        - provisioning/datasources
        - provisioning/dashboards
        - dashboards
      tags: [monitoring, setup]
    
    # ============================================
    # Phase 2: Copy Monitoring Configurations
    # ============================================
    - name: Copy docker-compose.yml
      copy:
        src: ../../Monitoring/docker-compose.yml
        dest: /home/ubuntu/monitoring/docker-compose.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      tags: [monitoring, config]
    
    - name: Copy Prometheus config
      copy:
        src: ../../Monitoring/prometheus/prometheus.yml
        dest: /home/ubuntu/monitoring/prometheus/prometheus.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      notify: reload prometheus
      tags: [monitoring, config]
    
    - name: Copy Prometheus rules
      copy:
        src: ../../Monitoring/prometheus/rules.yml
        dest: /home/ubuntu/monitoring/prometheus/rules.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      notify: reload prometheus
      tags: [monitoring, config]
    
    - name: Copy Alertmanager config
      copy:
        src: ../../Monitoring/alertmanager/alertmanager.yml
        dest: /home/ubuntu/monitoring/alertmanager/alertmanager.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      tags: [monitoring, config]
    
    - name: Copy Grafana datasource provisioning
      copy:
        src: ../../Monitoring/grafana-provisioning/datasources/prometheus.yml
        dest: /home/ubuntu/monitoring/grafana/provisioning/datasources/prometheus.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      when: false  # Will be created below
      tags: [monitoring, config]
    
    - name: Create Grafana datasource provisioning
      copy:
        dest: /home/ubuntu/monitoring/grafana/provisioning/datasources/prometheus.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        content: |
          apiVersion: 1
          datasources:
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://prometheus:9090
              isDefault: true
              editable: false
      tags: [monitoring, config]
    
    - name: Create Grafana dashboard provider
      copy:
        dest: /home/ubuntu/monitoring/grafana/provisioning/dashboards/default.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        content: |
          apiVersion: 1
          providers:
            - name: 'Default'
              orgId: 1
              folder: ''
              type: file
              disableDeletion: false
              updateIntervalSeconds: 10
              allowUiUpdates: true
              options:
                path: /var/lib/grafana/dashboards
      tags: [monitoring, config]
    
    - name: Copy Grafana dashboard JSON files
      copy:
        src: "../../Monitoring/grafana-dashboards/{{ item }}"
        dest: /home/ubuntu/monitoring/grafana/dashboards/{{ item }}
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      loop:
        - docker-container-monitoring.json
        - node-exporter-full.json
      tags: [monitoring, config]
    
    # ============================================
    # Phase 3: Deploy Monitoring Stack
    # ============================================
    - name: Start monitoring stack with Docker Compose
      shell: |
        cd /home/ubuntu/monitoring
        docker compose down || true
        docker compose up -d
      become_user: ubuntu
      environment:
        HOME: /home/ubuntu
      tags: [monitoring, deploy]
    
    - name: Wait for monitoring services to start
      wait_for:
        port: "{{ item }}"
        delay: 5
        timeout: 60
      loop:
        - 9090  # Prometheus
        - 3000  # Grafana
        - 9093  # Alertmanager
      register: port_check
      failed_when: false
      tags: [monitoring, deploy, validation]
    
    - name: Check container status if ports not ready
      shell: docker ps -a --filter name=alertmanager --filter name=prometheus --filter name=grafana
      become_user: ubuntu
      when: port_check is failed
      tags: [monitoring, deploy, validation]
    
    - name: Show container logs if Alertmanager failed
      shell: docker logs alertmanager
      become_user: ubuntu
      when: port_check is failed
      ignore_errors: yes
      tags: [monitoring, deploy, validation]
  
  handlers:
    - name: reload prometheus
      uri:
        url: "http://localhost:9090/-/reload"
        method: POST
      ignore_errors: yes
